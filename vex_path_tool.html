<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        display: none;
    }

    .tableCenter{
        margin-left: auto;
        margin-right: auto;
    }
</style>
</head>
<title>VEX Path</title>

    <div style="text-align:center;">
        <header style="font-size: 50px"><strong>VEX Path</strong></header>
        <br><br><br>
    </div>
    
    <div style="text-align:center;">
        <canvas id="canvas" style="border:1px solid #000000"></canvas>
    </div>
    <div style="display: none;">
        <img id="field_image" src="assets/field.png">
    </div>

    <script>
        var canvas = document.getElementById("canvas");

        canvas.width = 800;
        canvas.height = 800;
        pixelsPerInch = 3;
        pointHitBox = 10;
        pointSize = 5;
        snapTo = 12;
        
        PX_TO_INCHES = 1/pixelsPerInch;
        INCHES_TO_PX = pixelsPerInch;

        class Point{
            constructor(x,y){
                this.x = x;
                this.y = y;
            }
            headingToNext = 0;
            distanceToNext = 0;

            getPx_X() {
                return(inchesToPx_X(this.x));
            }
            getPx_Y() {
                return(inchesToPx_Y(this.y));
            }
        }

        points = [];

        function deletePoint(num){
            points.splice(num,1);
        }

        function print(message){
            console.log(message);
        }

        function updatePoints(){
            if(points.length > 0){
                for(i=1; i<points.length; i++){
                    points[i].distanceToNext = Math.sqrt((points[i].x-points[i-1].x)**2+(points[i].y-points[i-1].y)**2);
                    if(points[i].x-points[i-1].x > 0){
                        points[i].headingToNext = 90+Math.atan((points[i].y-points[i-1].y)/(points[i].x-points[i-1].x))*180/Math.PI;
                    }else{
                        points[i].headingToNext = 270+Math.atan((points[i].y-points[i-1].y)/(points[i].x-points[i-1].x))*180/Math.PI;
                    }
                }
            }
            drawCanvas();
        }

        function pxToInches_X(input){
            x = (input-canvas.width/2)*PX_TO_INCHES;
            if(snapTo != 0){
                x = Math.round(x/(snapTo))*(snapTo);
            }
            return(x);
        }
        function pxToInches_Y(input){
            y = (-input+canvas.height/2)*PX_TO_INCHES;
            if(snapTo != 0){
                y = Math.round(y/(snapTo))*(snapTo);
            }
            return(y);
        }

        function inchesToPx_X(input){
            return(input*INCHES_TO_PX+canvas.width/2);
        }
        function inchesToPx_Y(input){
            return(-input*INCHES_TO_PX+canvas.height/2);
        }

        function getX(input){
            x = pxToInches_X(input);
            if(x > 72){
                //x = 72;
            }
            if(x < -72){
                //x = -72;
            }
            return(x);
        }
        function getY(input){
            y = pxToInches_Y(input);
            if(y > 72){
                //y = 72;
            }
            if(y < -72){
                //y = -72;
            }
            return(y);
        }

        function drawCanvas(){
            var ctx = canvas.getContext("2d");
            ctx.clearRect(0,0,canvas.height,canvas.width);

            image = document.getElementById("field_image");
            imageScale = 206;
            imageH = imageScale*pixelsPerInch;
            imageW = 1024*(imageScale*pixelsPerInch)/768;
            ctx.globalAlpha = .65;
            ctx.drawImage(image,(canvas.width-imageW)/2,(canvas.height-imageH)/2,imageW,imageH);
            ctx.globalAlpha = 1;

            if(points.length > 0){
                //draw line 
                ctx.beginPath();
                ctx.moveTo(points[0].getPx_X(), points[0].getPx_Y());
                for(i=0; i<points.length; i++){
                    ctx.lineTo(points[i].getPx_X(), points[i].getPx_Y());
                }
                ctx.stroke();
                ctx.closePath();

                //draw points
                for(i=0; i<points.length; i++){
                    if(i == 0){
                        ctx.fillStyle = "red";
                    }else{
                        ctx.fillStyle = "black";
                    }
                    ctx.beginPath();
                    if(touchingPoint == i){
                        size = pointSize*2;
                    }else{
                        size = pointSize;
                    }
                    ctx.arc(points[i].getPx_X(), points[i].getPx_Y(), size, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.closePath();
                }
            }
        }
        
        function getTouching(x,y){
            for(i=points.length-1; i>=0; i--){
                if(Math.sqrt(((x-points[i].x))**2+(y-points[i].y)**2) < pointHitBox*PX_TO_INCHES){
                    touchingPoint = i;
                    return(i);
                }
            }
            touchingPoint = null;
            return(null);
        }

        canvas.oncontextmenu = function (e) {
            e.preventDefault();
        };

        mouseDown = false;
        selectedPoint = null;
        touchingPoint = null;
        canvas.onmousedown = function(event){
            mouseDown = true;
            x=getX(event.offsetX);
            y=getY(event.offsetY);
            selectedPoint = getTouching(x,y);
            if(event.button == 0){
                if(selectedPoint == null){
                    points.push(new Point(x,y));
                    touchingPoint = points.length-1;
                    selectedPoint = points.length-1;
                }else{
                }
            }
            //right click
            if(event.button == 2){
                if(selectedPoint != null){
                    deletePoint(selectedPoint);
                }
            }
            updatePoints();
        }

        canvas.onmouseup = function(event){
            x=getX(event.offsetX);
            y=getY(event.offsetY);
            mouseDown = false;
            updatePoints();
        }

        canvas.onmousemove = function(event){
            x=getX(event.offsetX);
            y=getY(event.offsetY);
            if(mouseDown && selectedPoint != null){
                points[selectedPoint].x = x;
                points[selectedPoint].y = y;
            }else{
                getTouching(x,y);
            }
            updatePoints();
        }

    </script>
    
</html>